# 智能报价助手 - OCR物料识别模块

## 项目背景
在建材行业中，供应商经常需要处理大量的询价单和物料清单。这些文档通常以表格图片的形式出现，手动录入不仅耗时且容易出错。本项目旨在通过OCR技术和智能匹配算法，实现建材物料信息的自动化识别和标准化，显著提升报价效率和准确性。

## 项目目标
1. 自动化处理：将人工录入转化为自动化处理，降低人工成本
2. 提升效率：将传统30分钟的人工录入缩短至1分钟内完成
3. 提高准确度：通过智能匹配算法，确保物料信息的准确性达到95%以上
4. 标准化输出：统一物料编码和规格描述，便于后续数据分析和管理

## 业务场景
1. 询价单处理
   - 供应商提供的询价清单（图片格式）
   - 客户手写/打印的物料需求表
   - 竞品报价单的分析

2. 物料匹配场景
   - 建材产品名称标准化（如："普通硅酸盐水泥"→"P.O 42.5"）
   - 规格型号解析（如：规格、材质、尺寸等）
   - 单位换算（如：吨、千克、方等）

## 功能范围
1. 文件处理能力
   - 图片格式：JPG、PNG、PDF
   - 表格文件：Excel格式（xlsx、xls）
   - 图片质量要求：≥300DPI
   - 处理能力：单次最多50个文件

2. 表格识别范围
   - 必需字段：物料名称、规格型号、数量、品牌
   - 表格类型：
     * 标准表格（带边框）
     * 非标准表格（无边框）
     * Excel电子表格
   - 文字内容：打印体文字（暂不支持手写体）

3. 物料匹配范围
   - 建材常用物料：消防器材、阀门类、管件类、钢材类（镀锌钢管、镀锌型材、衬塑管等）、水暖器材、五金辅材等
   - 规格参数：尺寸、材质、型号等
   - 计量单位：重量、长度、面积、体积等

## 项目简介
本模块是智能报价助手的核心组件，通过OCR技术实现询价单的自动识别，并将识别结果与系统物料库进行智能匹配，最终输出标准化的物料清单。该模块可以大大提高询价效率，减少人工录入错误。

## 核心功能
1. 文件上传与预处理
   - 支持图片和Excel文件上传
   - 图片质量优化与纠偏
   - Excel文件格式转换
   - 表格区域自动检测

2. 表格内容提取
   - 图片表格结构识别
   - Excel文件解析
   - 关键字段定位（名称、规格、数量、品牌）
   - 数据格式标准化

3. 物料信息匹配
   - 物料名称模糊匹配
   - 规格型号解析
   - 数量单位标准化
   - 置信度评分

4. 结果输出
   - 标准化物料清单
   - 异常数据标记
   - 匹配结果预览
   - 导出多种格式

## 技术架构
- 后端框架：FastAPI
- OCR引擎：PaddleOCR
- 数据库：MongoDB
- 文本相似度：Elasticsearch
- 前端界面：Vue.js

## 系统架构设计

### 1. 物料数据管理
- 数据来源：Excel格式的物料主数据清单
- 数据结构：
  * 物料编码
  * 物料名称
  * 规格型号（如：DN100、DN80等）
  * 单位（个、米等）
  * 物料分类（阀门类、管件类、钢材类等）
  * 连接方式（钢卡、卡簧、丝口等）
- 数据处理：
  * 支持批量导入
  * 数据格式校验
  * 重复数据检查
  * 数据标准化处理

### 2. 文件处理模块
- 批量处理：
  * 单次最多支持5个文件同时上传
  * 支持图片和Excel混合上传
  * 并行处理提升效率
- 表格识别策略：
  * 智能表头识别（基于关键字和位置特征）
  * 合并单元格处理
  * 多sheet页处理
  * 垂直/水平合并单元格自动识别

### 3. 字段映射规则
基于提供的表格样例，系统支持以下字段映射：
json
{
    "material_name": ["名称", "货物（劳务）名称", "产品名称", "物料名称"],
    "specification": ["规格", "规格型号", "型号", "口径"],
    "quantity": ["数量", "订货数量"],
    "unit": ["单位", "计量单位"],
    "connection": ["连接方式"],
    "remarks": ["备注", "说明", "注"]
}
```

### 4. 表格结构特征
根据样例分析，系统需处理以下表格特征：
1. 标准表格
   - 序号/编号列
   - 物料名称（必需，如：卡箍、沟槽大小头）
   - 规格型号（必需，如：DN100、DN100*80）
   - 数量和单位（必需，如：100个）
   - 连接方式（可选，如：钢卡、卡簧、丝口）

2. 非标准表格
   - 不规则表头
   - 合并单元格
   - 多级表头
   - 备注信息

## 开发计划（调整后）

### 第一阶段：基础架构搭建（预计5天）
1. 项目环境搭建（2天）
   - Python虚拟环境配置
   - 依赖包安装（包括OCR相关库）
   - 基础项目结构搭建
2. 数据库设计与实现（3天）
   - 物料主数据表
   - OCR任务表
   - 识别记录表

### 第二阶段：文件处理模块（预计15天）
1. 文件上传与预处理（3天）
   - 文件格式验证
   - 图片预处理
   - Excel解析
2. 表格结构识别（7天）
   - 表头智能识别
   - 合并单元格处理
   - 多sheet处理
3. 数据提取与标准化（5天）
   - 字段映射
   - 数据清洗
   - 格式标准化

### 第三阶段：物料匹配模块（预计10天）
1. 物料库管理（3天）
   - 物料数据导入
   - 数据索引建立
   - 同义词库建设
2. 匹配算法实现（7天）
   - 精确匹配实现
   - 模糊匹配实现
   - 规格解析匹配
   - 置信度计算

### 第四阶段：API和优化（预计5天）
1. API接口开发（3天）
   - 文件上传接口
   - 识别结果查询接口
   - 物料匹配接口
2. 性能优化（2天）
   - 并发处理优化
   - 响应速度优化
   - 内存使用优化

```## 示例数据结构

### 表格识别结果示例
```json
{
    "task_id": "T2024030100001",
    "file_type": "excel",
    "table_structure": {
        "headers": {
            "序号": 0,
            "名称": 1,
            "规格": 2,
            "单位": 3,
            "数量": 4,
            "连接方式": 5
        },
        "merged_cells": [
            {"start_row": 0, "end_row": 1, "start_col": 0, "end_col": 0}
        ],
        "data_rows": [
            {
                "row_index": 1,
                "material_name": "卡箍",
                "specification": "DN100",
                "unit": "个",
                "quantity": 100,
                "connection": "钢卡"
            }
        ]
    }
}
```

```## 项目结构

## 数据库设计

### 1. 物料主数据表（materials）
json
{
    "material_code": "string",         // 物料编码（来自金蝶云星空）
    "material_name": "string",         // 标准物料名称
    "specification": "string",         // 规格型号
    "unit": "string",                 // 基本单位
    "category": {                     // 物料分类
        "level1": "string",           // 一级分类（如：钢材类）
        "level2": "string"            // 二级分类（如：镀锌钢管）
    },
    "attributes": {                   // 物料属性
        "material": "string",         // 材质
        "size": "string",            // 尺寸
        "standard": "string"         // 执行标准
    },
    "status": "boolean",             // 启用状态
    "created_at": "datetime",        // 创建时间
    "updated_at": "datetime"         // 更新时间
}
```

### 2. 物料同义词表（material_synonyms）
```json
{
    "standard_code": "string",       // 标准物料编码（关联物料主数据）
    "synonym": "string",            // 同义词名称
    "match_type": "string",        // 匹配类型（完全匹配/模糊匹配）
    "confidence": "float",         // 置信度（0-1）
    "source": "string",           // 来源（手动添加/自动学习）
    "created_at": "datetime",     // 创建时间
    "updated_at": "datetime"      // 更新时间
}
```

### 3. OCR任务表（ocr_tasks）
```json
{
    "task_id": "string",           // 任务ID
    "file_url": "string",          // 文件URL
    "file_type": "string",         // 文件类型（image/excel）
    "status": "string",            // 任务状态（待处理/处理中/完成/失败）
    "result": {
        "table_structure": "json",  // 表格结构
        "required_fields": {        // 必需字段
            "name_col": "integer",  // 物料名称列索引
            "spec_col": "integer",  // 规格型号列索引
            "qty_col": "integer",   // 数量列索引
            "brand_col": "integer"  // 品牌列索引
        },
        "cells": "array"           // 单元格内容
    },
    "created_at": "datetime",      // 创建时间
    "completed_at": "datetime"     // 完成时间
}
```

### 4. 物料匹配记录表（matching_records）
```json
{
    "record_id": "string",        // 记录ID
    "task_id": "string",         // 关联OCR任务ID
    "original_text": "string",   // 原始文本
    "matched_code": "string",    // 匹配到的物料编码
    "confidence": "float",       // 匹配置信度
    "match_type": "string",     // 匹配类型（完全/模糊/人工确认）
    "created_at": "datetime"    // 创建时间
}
```

## 匹配规则设计

### 1. 分级匹配策略
1. 完全匹配：与标准名称或同义词完全一致
2. 分类限定匹配���在特定分类下进行模糊匹配
3. 规格解析匹配：通过规格型号进行辅助匹配
4. 模糊匹配：基于文本相似度算法

### 2. 置信度计算
- 完全匹配：置信度 = 1.0
- 同义词匹配：置信度 = 0.9
- 分类限定匹配：置信度 = 0.8
- 规格解析匹配：置信度 = 0.7
- 模糊匹配：置信度 = 相似度得分（0.5-0.7）

### 3. 匹配优化策略
1. 分类预过滤：基于上下文推断物料分类
2. 规格标准化：统一规格表达格式
3. 同义词动态学习：记录人工确认的匹配结果
4. 上下文关联：利用相邻物料信息辅助匹配

